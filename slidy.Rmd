---
output: slidy_presentation
theme: spacelab
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 14, fig.height = 5)
```


## Spatial analysis of barrier data

Using water network shapefile and up to date barrier data, river networks can be analysed to show both the effects of passable and impassable barriers on fish migration.

For example zooming onto a smaller area in the Combined Essex catchment:

```{r echo = FALSE, warning = FALSE, message=FALSE}
library(raster)
library(htmltools)
library(htmlwidgets)
library(htmlTable)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.esri)
library(geojsonio)

map <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/1/barriers.geojson", what = "sp")
rivers <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/1/rivers.geojson", what = "sp")

leaflet() %>%
  addTiles(
    urlTemplate = '//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png',
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>', group = "Mapbox") %>%
  addProviderTiles(providers$OpenMapSurfer.Roads, group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri") %>%
  addEsriBasemapLayer(esriBasemapLayers$DarkGray, autoLabels = F, group = "DarkGrey") %>%
  addPolylines(data = rivers, group = "Rivers", label = ~htmlEscape(Name), color = "#2870b2", weight = 4, opacity = 1, fillOpacity = 1) %>%
  addCircles(data = map, color = "#b22870", opacity = 1, fill = TRUE, group = "Barriers") %>%
  addLayersControl(baseGroups = c("Mapbox", "OSM", "Esri", "DarkGrey"), 
                   overlayGroups = c("Barriers", "Rivers"), position = "topright",
                   options = layersControlOptions(collapsed = F)) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Home",
    onClick = JS("function(btn, map){ map.setZoom(9);}")))
```


## Splitting and measuring river length

Using geoprocessing tools, the river network can be split and length of river can be calculated upstream of each barrier. (Zoom on and hover on the river section to show river length (m)).

```{r echo = FALSE, warning = FALSE, message=FALSE}
library(raster)
library(htmltools)
library(htmlwidgets)
library(htmlTable)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.esri)
library(geojsonio)

map <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/2/barrier_snapped.geojson", what = "sp")
rivers <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/2/func_rivers.geojson", what = "sp")

library(RColorBrewer)
pal <- colorRampPalette(c("yellow", "green", "blue", "blue1", "blue2", "blue3", "red", "purple", "pink", "orange", "black", "grey", "brown", "lightcoral", "lightgreen", "lightsalmon", "lightslateblue"))

leaflet() %>%
  addTiles(
    urlTemplate = '//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png',
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>', group = "Mapbox") %>%
  addProviderTiles(providers$OpenMapSurfer.Roads, group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri") %>%
  addEsriBasemapLayer(esriBasemapLayers$DarkGray, autoLabels = F, group = "DarkGrey") %>%
  addPolylines(data = rivers, group = "Rivers", label = ~htmlEscape(~as.character(batDis2Mth)), color = ~pal(rivers$batNetID), weight = 4, opacity = 1, fillOpacity = 1) %>%
  addCircles(data = map, color = "#b22870", weight = 8, opacity = 1, fill = TRUE, group = "Barriers") %>%
  addLayersControl(baseGroups = c("Mapbox", "OSM", "Esri", "DarkGrey"), 
                   overlayGroups = c("Barriers", "Rivers"), position = "topright",
                   options = layersControlOptions(collapsed = F)) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Home",
    onClick = JS("function(btn, map){ map.setZoom(9);}")))
```


## Visualising those barriers that are passsable

Passable barriers: where pass have been installed and WFD fish priority score <= 2 / Eel regulations priority score <= 2.

```{r echo = FALSE, warning = FALSE, message=FALSE}
library(raster)
library(htmltools)
library(htmlwidgets)
library(htmlTable)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.esri)
library(geojsonio)

map1 <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/3/passable_fish.geojson", what = "sp")
rivers <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/3/func_rivers.geojson", what = "sp")

m1 <- leaflet() %>%
  addTiles(
    urlTemplate = '//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png',
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>', group = "Mapbox") %>%
  addProviderTiles(providers$OpenMapSurfer.Roads, group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri") %>%
  addEsriBasemapLayer(esriBasemapLayers$DarkGray, autoLabels = F, group = "DarkGrey") %>%
  addPolylines(data = rivers, group = "Rivers", label = ~htmlEscape(Name), color = "#2870b2", weight = 4, opacity = 1, fillOpacity = 1) %>%
  addCircles(data = map1, color = "#c10c79", weight = 6, opacity = 1, fill = TRUE, group = "Passable for fish") %>%
  addLayersControl(baseGroups = c("Mapbox", "OSM", "Esri", "DarkGrey"), 
                   overlayGroups = c("Passable for fish", "Rivers"), position = "topright",
                   options = layersControlOptions(collapsed = F)) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Home",
    onClick = JS("function(btn, map){ map.setZoom(9);}")))

map2 <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/3/passable_eel.geojson", what = "sp")
rivers <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/3/func_rivers.geojson", what = "sp")

m2 <- leaflet() %>%
  addTiles(
    urlTemplate = '//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png',
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>', group = "Mapbox") %>%
  addProviderTiles(providers$OpenMapSurfer.Roads, group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri") %>%
  addEsriBasemapLayer(esriBasemapLayers$DarkGray, autoLabels = F, group = "DarkGrey") %>%
  addPolylines(data = rivers, group = "Rivers", label = ~htmlEscape(Name), color = "#2870b2", weight = 4, opacity = 1, fillOpacity = 1) %>%
  addCircles(data = map2, color = "#a88ad4", weight = 6, opacity = 1, fill = TRUE, group = "Passable for eels") %>%
  addLayersControl(baseGroups = c("Mapbox", "OSM", "Esri", "DarkGrey"), 
                   overlayGroups = c("Passable for eels", "Rivers"), position = "topright",
                   options = layersControlOptions(collapsed = F)) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Home",
    onClick = JS("function(btn, map){ map.setZoom(9);}")))

latticeView(m1, m2)
```


## Viualising open and closed waterways

Waterways open (green) after pass installation and waterways still remain closed (red).

```{r echo = FALSE, warning = FALSE, message=FALSE}
library(raster)
library(htmltools)
library(htmlwidgets)
library(htmlTable)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.esri)
library(geojsonio)

c <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/4/barriers_closed.geojson", what = "sp")
o <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/4/barriers_open.geojson", what = "sp")
rivers <- geojsonio::geojson_read("E:/Work/Roadmap/Essex map/R Essex/slidy/4/rivers.geojson", what = "sp")

library(RColorBrewer)
pal2 <- colorNumeric(c("green", "red"), domain = rivers$River_stat)

leaflet() %>%
  addTiles(
    urlTemplate = '//{s}.tiles.mapbox.com/v3/jcheng.map-5ebohr46/{z}/{x}/{y}.png',
    attribution = 'Maps by <a href="http://www.mapbox.com/">Mapbox</a>', group = "Mapbox") %>%
  addProviderTiles(providers$OpenMapSurfer.Roads, group = "OSM") %>%
  addProviderTiles(providers$Esri.WorldImagery, group = "Esri") %>%
  addEsriBasemapLayer(esriBasemapLayers$DarkGray, autoLabels = F, group = "DarkGrey") %>%
  addPolylines(data = rivers, group = "Rivers", color = ~pal2(rivers$River_stat), weight = 4, opacity = 1, fillOpacity = 1) %>%
  addCircles(data = o, color = "#008000", opacity = 1, fill = TRUE, group = "Passable barriers") %>%
  addCircles(data = c, color = "#990000", opacity = 1, fill = TRUE, group = "Impassable barriers") %>%
  addLayersControl(baseGroups = c("Mapbox", "OSM", "Esri", "DarkGrey"), 
                   overlayGroups = c("Passable barriers", "Impassable barriers", "Rivers"), position = "topright",
                   options = layersControlOptions(collapsed = F)) %>%
  addScaleBar(position = "bottomleft") %>%
  addEasyButton(easyButton(
    icon = "fa-globe", title = "Home",
    onClick = JS("function(btn, map){ map.setZoom(9);}")))
```
